{% extends "base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'course_css/add-course.css' %}">
{% endblock %}

{% block content %}
<div class="container">
  <h2 class="mb-4">ðŸ“š Add New Course</h2>

  <!-- Information Alert -->
  <div class="alert alert-info" role="alert">
    <strong>Important:</strong> All courses must have a course category and sub-course selected. 
    If you don't see sub-courses in the dropdown, please go to 
    <a href="{% url 'create_course' %}" class="alert-link">Create Course</a> first to set up the course structure.
  </div>

  <form method="POST" id="courseForm">
    {% csrf_token %}
    <fieldset>
      <legend class="w-auto">Course Information</legend>

      <div class="mb-2">
        <label for="{{ form.name.id_for_label }}">Course Name: <span class="text-danger">*</span></label>
        {{ form.name }}
        {% if form.name.errors %}
          <div class="text-danger small">{{ form.name.errors.0 }}</div>
        {% endif %}
      </div>

      <div class="mb-2">
        <label for="{{ form.sub_column.id_for_label }}">Sub Column: <span class="text-danger">*</span></label>
        {{ form.sub_column }}
        {% if form.sub_column.errors %}
          <div class="text-danger small">{{ form.sub_column.errors.0 }}</div>
        {% endif %}
        <small class="form-text text-muted">Select a course category first to see available sub-courses.</small>
      </div>

      <div class="mb-2">
        <label for="{{ form.unicode.id_for_label }}">Unicode:</label>
        {{ form.unicode }}
      </div>

      <div class="mb-2">
        <label for="{{ form.description.id_for_label }}">Description:</label>
        {{ form.description }}
      </div>

      <div class="mb-2">
        <label for="{{ form.start_date.id_for_label }}">Start Date:</label>
        {{ form.start_date }}
      </div>

      <div class="mb-2">
        <label for="{{ form.end_date.id_for_label }}">End Date:</label>
        {{ form.end_date }}
      </div>

      <div class="mb-2">
        <label for="{{ form.fees.id_for_label }}">Fees (â‚¹):</label>
        {{ form.fees }}
      </div>
    </fieldset>

    <button type="submit" class="btn btn-success mt-3" id="submitBtn">Create Course</button>
  </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Function to generate unicode
function generateUnicode() {
  const courseSelect = document.getElementById('id_name');
  const unicodeField = document.getElementById('id_unicode');
  
  if (!courseSelect || !unicodeField) {
    return;
  }
  
  const selectedCourse = courseSelect.value;
  let prefix = 'GEN';
  
  if (selectedCourse) {
    // Get the selected option text
    const selectedOption = courseSelect.options[courseSelect.selectedIndex];
    if (selectedOption) {
      prefix = selectedOption.text.substring(0, 3).toUpperCase();
    }
  }
  
  // Generate 5 random digits
  const digits = Math.floor(10000 + Math.random() * 90000);
  const unicode = `${prefix}${digits}`;
  
  unicodeField.value = unicode;
  console.log('Generated unicode:', unicode);
}

// Function to update sub column options via AJAX
function updateSubColumns() {
  const courseSelect = document.getElementById('id_name');
  const subColumnSelect = document.getElementById('id_sub_column');
  
  if (!courseSelect || !subColumnSelect) {
    console.log('Select elements not found');
    return;
  }
  
  const selectedCourseId = courseSelect.value;
  console.log('Selected course ID:', selectedCourseId);
  
  if (!selectedCourseId) {
    // Clear sub column options if no course is selected
    subColumnSelect.innerHTML = '<option value="">Select a sub course</option>';
    return;
  }
  
  // Make AJAX request to get sub-courses
  fetch(`{% url 'get_sub_courses' %}?course_category_id=${selectedCourseId}`)
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.json();
    })
    .then(data => {
      console.log('Sub courses data:', data);
      
      // Clear existing options
      subColumnSelect.innerHTML = '<option value="">Select a sub course</option>';
      
      // Add new options
      if (data.sub_courses && data.sub_courses.length > 0) {
        data.sub_courses.forEach(subCourse => {
          const option = document.createElement('option');
          option.value = subCourse.id;
          option.textContent = subCourse.name;
          subColumnSelect.appendChild(option);
        });
      } else {
        // Show message if no sub-courses found
        subColumnSelect.innerHTML = '<option value="">No sub-courses available for this category</option>';
      }
      
      // Generate new unicode when course changes
      generateUnicode();
      
      console.log('Sub column updated');
    })
    .catch(error => {
      console.error('Error fetching sub-courses:', error);
      subColumnSelect.innerHTML = '<option value="">Error loading sub-courses</option>';
    });
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
  const courseSelect = document.getElementById('id_name');
  const subColumnSelect = document.getElementById('id_sub_column');
  const submitBtn = document.getElementById('submitBtn');
  const courseForm = document.getElementById('courseForm');
  
  if (courseSelect && subColumnSelect) {
    console.log('Elements found, setting up event listeners');
    
    // Add event listener for course selection change
    courseSelect.addEventListener('change', updateSubColumns);
    
    // Initialize sub columns based on current selection
    if (courseSelect.value) {
      updateSubColumns();
    }
    
    // Generate unicode if course is pre-filled
    if (courseSelect.value) {
      generateUnicode();
    }
  } else {
    console.log('Required elements not found');
  }
  
  // Handle form submission
  if (courseForm) {
    courseForm.addEventListener('submit', function(e) {
      // Generate unicode if not already generated
      const unicodeField = document.getElementById('id_unicode');
      if (unicodeField && !unicodeField.value) {
        generateUnicode();
      }
      
      // Disable submit button to prevent double submission
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Creating...';
      }
    });
  }
});
</script>
{% endblock %}
